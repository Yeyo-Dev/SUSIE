<div class="exam-engine-shell">
    <!-- Header: Timer & Progress -->
    <header class="engine-header">
        <div class="timer-badge" [class.urgent]="isUrgent()">
            <span class="timer-icon">‚è≥</span>
            <span class="timer-value">{{ timerFormatted() }}</span>
        </div>

        @if (config().sessionContext.examTitle; as title) {
        <div class="exam-title-bar">
            <h1>{{ title }}</h1>
        </div>
        }

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="progressPercent()"></div>
            </div>
            <span class="progress-text">
                Pregunta {{ currentIndex() + 1 }} de {{ questions().length }}
            </span>
        </div>
    </header>

    <!-- Toasts (Notificaciones) -->
    @if (toast(); as t) {
    <div class="toast-overlay" [class]="t.type">
        <div class="toast-card">
            <span class="toast-icon">
                @switch (t.type) {
                @case ('info') { ‚ÑπÔ∏è }
                @case ('warning') { ‚ö†Ô∏è }
                @case ('critical') { üö® }
                }
            </span>
            <span class="toast-message">{{ t.message }}</span>
            <button class="toast-close" (click)="dismissToast()" aria-label="Cerrar notificaci√≥n">‚úï</button>
        </div>
    </div>
    }

    <!-- Modal de Confirmaci√≥n de Env√≠o -->
    @if (showConfirmModal()) {
    <div class="confirm-backdrop">
        <div class="confirm-card">
            <div class="confirm-icon">üì§</div>
            <h3>¬øFinalizar Examen?</h3>
            
            <p>
                Has respondido <strong>{{ answeredCount() }}</strong> de <strong>{{ questions().length }}</strong> preguntas.
            </p>

            @if (questions().length > answeredCount()) {
                <p class="warning-text">‚ö†Ô∏è Tienes preguntas sin responder.</p>
            }

            <div class="confirm-actions">
                <button class="btn btn-secondary" (click)="cancelSubmit()">Volver</button>
                <button class="btn btn-submit" (click)="confirmSubmit()">Enviar Todo</button>
            </div>
        </div>
    </div>
    }

    <!-- Main Content: Pregunta Actual -->
    <main class="engine-body">
        @if (currentQuestion(); as question) {
        <div class="question-card">
            <h2 class="question-title">
                <span class="question-number">{{ question.id }}.</span>
                {{ question.content }}
            </h2>

            <!-- Opciones -->
            <div class="options-list">
                @for (opt of question.options; track opt) {
                <label class="option-item" [class.selected]="answers()[question.id] === opt">
                    <input type="radio" [name]="'q' + question.id" [value]="opt"
                        [checked]="answers()[question.id] === opt" (change)="selectAnswer(question.id, opt)">
                    <div class="option-content">
                        <div class="radio-circle"></div>
                        <span class="option-text">{{ opt }}</span>
                    </div>
                </label>
                }
            </div>
        </div>
        }
    </main>

    <!-- Footer: Navegaci√≥n -->
    <footer class="engine-footer">
        <button class="btn btn-secondary" [disabled]="currentIndex() === 0" (click)="prevQuestion()">
            Anterior
        </button>

        @if (currentIndex() < questions().length - 1) { <button class="btn btn-primary" (click)="nextQuestion()">
            Siguiente
            </button>
            } @else {
            <button class="btn btn-submit" (click)="submitExam()">
                Finalizar Examen
            </button>
            }
    </footer>
</div>
